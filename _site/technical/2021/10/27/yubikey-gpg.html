<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign your git commits using your Yubikey + GPG (OS X) | Felix Sargent</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/components/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/components/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/components/images/favicon-16x16.png">
    <link rel="manifest" href="/components/images/site.webmanifest">
    <link rel="mask-icon" href="/components/images/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@felixsargent">
    <meta name="twitter:title" content="Felix Sargent">
    <meta name="twitter:description" content="Software Engineering Leadership | Social Choice Theory">
    <meta name="twitter:image" content="https://felixsargent.com/components/images/headshots/felix-roughlinen-headshot.jpg">

    <meta property="og:title" content="Felix Sargent" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://felixsargent.com/" />
    <meta property="og:image" content="https://felixsargent.com/components/images/headshots/felix-roughlinen-headshot.jpg" />
    <meta property="og:description" content="Software Engineering Leadership | Social Choice Theory" />

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <a href="/"><img src="/components/images/headshots/yellow circle2.jpeg" alt="Felix Sargent Headshot" style="width: 150px;"></a>
            <h1><a href="/">Felix Sargent</a></h1>
            <p>Software Engineering Leadership | Social Choice Theory</p>
        </header>
        <nav>
            <a href="/resume.html">Resume</a>
        </nav>

        <h2 id="sign-your-git-commits-using-your-yubikey--gpg-os-x">Sign your git commits using your Yubikey + GPG (OS X)</h2>

<p><em>October 27, 2021</em></p>

<p>Using GPG can feel like a miniature nightmare of being stuck in a maze. There are too many options, and it’s hard to know which are “safe” or reasonable. In our organization we wanted to ensure that all our commits were signed so that we could trust that the code in our repositories were ours.</p>

<p>This is a guide to set it up Yubikeys and GPG Suite from scratch.</p>

<h3 id="1-installation">1. Installation</h3>

<p>First off, using Homebrew, install git, ykman (Yubikey Manager) and gpg-suite.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew <span class="nb">install </span>git ykman gpg-suite
</code></pre></div></div>

<h3 id="2-key-generation">2. Key Generation</h3>

<p>Ensure you have your Yubikey plugged in now.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gpg <span class="nt">--card-edit</span>
</code></pre></div></div>

<p>This will output something like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Reader ...........: Yubico YubiKey OTP FIDO CCID
Application ID ...: D2760001240103040006169214170000
Application type .: OpenPGP
Version ..........: 3.4
Manufacturer .....: Yubico
Serial number ....: 16921417
Name of cardholder: [not set]
Language prefs ...: [not set]
Salutation .......:
URL of public key : [not set]
Login data .......: [not set]
Signature PIN ....: not forced
Key attributes ...: rsa2048 rsa2048 rsa2048
Max. PIN lengths .: 127 127 127
PIN retry counter : 3 0 3
Signature counter : 0
KDF setting ......: off
Signature key ....: [none]
Encryption key....: [none]
Authentication key: [none]
General key info..: [none]
</code></pre></div></div>

<p>Now, enter admin mode:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gpg/card&gt; admin
Admin commands are allowed
</code></pre></div></div>

<p>We’re now in the GPG card editor, and we’re going to start generating a key on the yubikey itself.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gpg/card&gt; generate
Make off-card backup of encryption key? (Y/n) y
</code></pre></div></div>

<p>Please note that the factory settings of the PINs are <code class="language-plaintext highlighter-rouge">PIN = '123456'</code> and <code class="language-plaintext highlighter-rouge">Admin PIN = '12345678'</code>. You should change them using the <code class="language-plaintext highlighter-rouge">passwd</code> command.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Please specify how long the key should be valid.
0 = key does not expire
&lt;n&gt;  = key expires in n days
&lt;n&gt;w = key expires in n weeks
&lt;n&gt;m = key expires in n months
&lt;n&gt;y = key expires in n years
Key is valid for? (0) 2y
Key expires at Fri Oct 27 11:59:03 2023 PDT
Is this correct? (y/N) y

GnuPG needs to construct a user ID to identify your key.

Real name: Felix Sargent
Email address: felix@example.com
Comment: Yubikey for Example
You selected this USER-ID:
    "Felix Sargent (Yubikey for Example) &lt;felix@example.com&gt;"

Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? o
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
gpg: Note: backup of card key saved to '/Users/felix/.gnupg/sk_758CFF2393B22B10.gpg'
gpg: key 1DD85DE9D27C4A68 marked as ultimately trusted
gpg: revocation certificate stored as '/Users/felix/.gnupg/openpgp-revocs.d/73C92609075C87FB8545214E1DD85DE9D27C4A68.rev'
public and secret key created and signed.
</code></pre></div></div>

<h3 id="3-upload-public-key-to-github">3. Upload Public Key to GitHub</h3>

<p>Now that’s done, open up the GPG-Keychain application in <code class="language-plaintext highlighter-rouge">/Applications/GPG-Keychain.app</code>. Export your public key to your desktop. It’ll be an <code class="language-plaintext highlighter-rouge">.asc</code> file. <strong>Do not export the private key.</strong></p>

<p>Back to the terminal. See what’s in the <code class="language-plaintext highlighter-rouge">.asc</code> file using <code class="language-plaintext highlighter-rouge">cat</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> ~/Documents/Felix<span class="se">\\</span> Sargent<span class="se">\\</span> <span class="se">\\</span><span class="o">(</span>D27C4A68<span class="se">\\</span><span class="o">)</span><span class="se">\\</span> –<span class="se">\\</span> Public.asc
</code></pre></div></div>

<p>This will output your public key block:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-----BEGIN PGP PUBLIC KEY BLOCK-----
mDMEYXmhiRYJKwYBBAHaRw8BAQdAzUGoX8W3VGDm1LVDE9LmIHDK/6KRGIckUQff
K8a7Swe0OUZlbGl4IFNhcmdlbnQgKFl1YmlrZXkgZm9yIFRydWV3b3JrKSA8ZmVs
aXhAdHJ1ZXdvcmsuY29tPoiWBBMWCAA+FiEEc8kmCQdch/uFRSFOHdhd6dJ8SmgF
AmF5oYkCGwMFCQPCZwAFCwkIBwIGFQoJCAsCBBYCAwECHgECF4AACgkQHdhd6dJ8
Smi/ygEAsPSluOpRWPOptPYU37iwxBhxt7vQCjqZiNwNSMCLB0AA/RDNXXqv0rVx
nUHysWLKkl5UR5fcTT+sK1a4TMCzp5APuDMEYXmhiRYJKwYBBAHaRw8BAQdA1ALY
TVhlqYUon59rdmmUF99vMpBZ+8eq0oeM/uAaTkKIfgQYFggAJhYhBHPJJgkHXIf7
hUUhTh3YXenSfEpoBQJheaGJAhsgBQkDwmcAAAoJEB3YXenSfEpo7pUA/0dTRqrY
XjQxWsNMB5nni46d82Ed5x8XZ0S8qXso5+DWAP9ebn/UFYdnTaKLUST0wi5X+mXP
A7DT4UTqhg7b02ONCrg4BGF5oYkSCisGAQQBl1UBBQEBB0DZode07GKwgdicUpHL
p+VWeezqPaP95pxGTAPsk+ghbgMBCAeIfgQYFggAJhYhBHPJJgkHXIf7
hUUhTh3YXenSfEpoBQJheaGJAhsMBQkDwmcAAAoJEB3YXenSfEpocEwA/07sid3xhK5L/rIe
SxX0KPtDk/JKODZsxWuxLt+OfGjxAPsFNRMyAcme+go90tkYjlh2+jqVdH1/szzj
npvgZCNTCA==
=CDad
-----END PGP PUBLIC KEY BLOCK-----
</code></pre></div></div>

<p>Copy this to your clipboard, open <a href="https://github.com/settings/keys">https://github.com/settings/keys</a>, click “New GPG Key”, and paste it in.</p>

<h3 id="4-configure-git">4. Configure Git</h3>

<p>Now back in the terminal, we have to tell git to use your Yubikey’s GPG Signing Key. Identify the key using the key ID, which you can find in GPG Suite’s GUI.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git config <span class="nt">--global</span> gpg.program gpg
git config <span class="nt">--global</span> user.signingkey D27C4A68
</code></pre></div></div>

<p>Now when ever we make a commit Git will reach out to GPG to sign the commit. You don’t need to touch your Yubikey to do this, but you do need to have it plugged in. Try signing a commit without your yubikey to validate that it’s working properly.</p>

<h3 id="5-hardening">5. Hardening</h3>

<p>You should change the pin on your Yubikey. Instructions for that are here: <a href="https://github.com/drduh/YubiKey-Guide#change-pin">https://github.com/drduh/YubiKey-Guide#change-pin</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gpg <span class="nt">--change-pin</span>
</code></pre></div></div>

<p>This will give you a menu:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gpg: OpenPGP card no. D2760001240102010006055532110000 detected

1 - change PIN
2 - unblock PIN
3 - change Admin PIN
4 - set the Reset Code
Q - quit
</code></pre></div></div>

<p>To require touch to sign:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ykman openpgp keys set-touch aut on <span class="nt">-f</span>
ykman openpgp keys set-touch sig on <span class="nt">-f</span>
ykman openpgp keys set-touch enc on <span class="nt">-f</span>
</code></pre></div></div>


        <footer>
            <p>
                <a href="https://www.linkedin.com/in/felixsargent/">LinkedIn</a> |
                <a href="https://github.com/fsargent">GitHub</a> |
                <a href="https://twitter.com/felixsargent">Twitter</a> |
                <a href="https://medium.com/@felix.sargent">Medium</a>
            </p>
        </footer>
    </div>
</body>
</html>
